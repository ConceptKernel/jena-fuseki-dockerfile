{{- if .Values.security.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "jena-fuseki.fullname" . }}-config
  labels:
    {{- include "jena-fuseki.labels" . | nindent 4 }}
data:
  shiro.ini: |
    [main]
    # Development
    ssl.enabled = false

    # Basic Auth filter
    authcBasic = org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter
    authcBasic.applicationName = Apache Jena Fuseki

    # Session Management
    sessionManager = org.apache.shiro.web.session.mgt.DefaultWebSessionManager
    securityManager.sessionManager = $sessionManager

    [users]
    {{ .Values.security.adminUser }}={{ include "jena-fuseki.adminPassword" . }}

    [roles]
    {{ .Values.security.adminUser }} = *

    [urls]
    ## Public endpoints (no authentication required)
    /$/ping = anon
    /$/stats = anon
    /$/metrics = anon

    {{- if eq (include "jena-fuseki.adminPassword" .) "disabled" }}
    ## Open access mode - no authentication required
    /** = anon
    {{- else if .Values.security.publicRead }}
    ## Public read access mode - UI and queries are public, writes require auth

    ## Admin endpoints - require authentication
    /$/stats/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/datasets/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/tasks = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/tasks/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/backups/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/compact/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/server = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/server/** = authcBasic,roles[{{ .Values.security.adminUser }}]

    ## UI files - public access
    /index.html = anon
    /static/** = anon
    /favicon.ico = anon

    ## Private datasets (fully protected)
    {{- range .Values.security.privateDatasets }}
    /{{ . }}/** = authcBasic,roles[{{ $.Values.security.adminUser }}]
    {{- end }}

    ## Write operations - require authentication
    /**/update = authcBasic,roles[{{ .Values.security.adminUser }}]
    /**/data = authcBasic,roles[{{ .Values.security.adminUser }}]
    /**/upload = authcBasic,roles[{{ .Values.security.adminUser }}]

    ## Read operations - public access
    /**/query = anon
    /**/sparql = anon
    /**/get = anon

    ## Everything else - public (allows browsing datasets)
    /** = anon
    {{- else }}

    {{- if .Values.security.localhostOnly }}
    ## Admin endpoints (localhost + authentication required)
    ## Note: localhostFilter not implemented, using authcBasic instead
    /$/stats/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/datasets = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/datasets/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/tasks = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/tasks/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/backups/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/compact/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/server = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/server/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    {{- else }}
    ## Admin endpoints (authentication required, external access allowed)
    /$/stats/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/datasets = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/datasets/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/tasks = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/tasks/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/backups/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/compact/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/server = authcBasic,roles[{{ .Values.security.adminUser }}]
    /$/server/** = authcBasic,roles[{{ .Values.security.adminUser }}]
    {{- end }}

    {{- if .Values.ui.enabled }}
    ## Web UI (authentication required for everything)
    /index.html = authcBasic,roles[{{ .Values.security.adminUser }}]
    /** = authcBasic,roles[{{ .Values.security.adminUser }}]
    {{- else }}
    ## SPARQL endpoints (authentication required for updates)
    /**/update = authcBasic,roles[{{ .Values.security.adminUser }}]
    /**/data = authcBasic,roles[{{ .Values.security.adminUser }}]
    /**/upload = authcBasic,roles[{{ .Values.security.adminUser }}]

    ## SPARQL queries (authentication required)
    /**/query = authcBasic,roles[{{ .Values.security.adminUser }}]
    /**/sparql = authcBasic,roles[{{ .Values.security.adminUser }}]

    ## Everything else
    /** = authcBasic,roles[{{ .Values.security.adminUser }}]
    {{- end }}
    {{- end }}
{{- end }}
